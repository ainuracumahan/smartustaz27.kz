<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мониторинг | SmartUstaz</title>
    <link rel="stylesheet" href="../static/styles/style.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

<header class="header">
    <div class="container header-flex">
        <h1 class="logo">SmartUstaz</h1>
        <nav>
            <ul class="nav-menu">
                <li><a href="../index.html">Басты бет</a></li>
                <li><a href="../services.html" class="active">Материалдар</a></li>
                <li><a href="#" class="active">Мониторинг</a></li>
                <li><a href="../atestat1.html" class="active">Аттестация</a></li>
                <li><a href="../auth.html" class="active">Кіру</a></li>
            </ul>
        </nav>
    </div>
</header>

<main class="container" style="margin-top:40px; margin-bottom:60px;">

    <h2 style="margin-bottom:20px;">Білім сапасының мониторингі</h2>

    <!-- Фильтрлер -->
    <div class="monitor-filters">
        <select id="classFilter">
            <option>7 сынып</option>
            <option>8 сынып</option>
            <option>9 сынып</option>
        </select>

        <select id="subjectFilter">
            <option>Математика</option>
            <option>Физика</option>
            <option>Қазақ тілі</option>
        </select>

        <select id="termFilter">
            <option>1 тоқсан</option>
            <option>2 тоқсан</option>
            <option>3 тоқсан</option>
        </select>

        <button class="btn-primary" onclick="applyFilter()">Қолдану</button>
    </div>

    <!-- Кесте -->
    <div class="monitor-table-wrapper">
        <table class="monitor-table" id="monitorTable">
            <thead>
                <tr>
                    <th>Оқушы</th>
                    <th>5</th>
                    <th>4</th>
                    <th>3</th>
                    <th>2</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr>
                    <td><strong>Барлығы</strong></td>
                    <td id="total5">0</td>
                    <td id="total4">0</td>
                    <td id="total3">0</td>
                    <td id="total2">0</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- График -->
    <div style="max-width:350px; margin-top:40px;">
        <canvas id="gradeChart"></canvas>
    </div>

    <!-- Экспорт -->
    <div style="margin-top:20px;">
        <button class="btn-secondary" onclick="exportExcel()">Excel жүктеу</button>
    </div>

</main>

<footer class="main-footer">
    <div class="container">
        <span>© №27 Ыбырай Алтынсарин атындағы орта мектеп</span>
    </div>
</footer>

<script>
const studentsData = [
  { name: "Айнұр Н.", grades: { 5: 12, 4: 3, 3: 0, 2: 0 } },
  { name: "Бекзат С.", grades: { 5: 10, 4: 5, 3: 1, 2: 0 } },
  { name: "Жанель Т.", grades: { 5: 15, 4: 1, 3: 0, 2: 0 } }
];

function updateTable(data) {
  const tbody = document.querySelector("#monitorTable tbody");
  tbody.innerHTML = "";

  let total5=0,total4=0,total3=0,total2=0;

  data.forEach(s=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${s.name}</td>
      <td>${s.grades[5]}</td>
      <td>${s.grades[4]}</td>
      <td>${s.grades[3]}</td>
      <td>${s.grades[2]}</td>
    `;
    tbody.appendChild(tr);

    total5+=s.grades[5];
    total4+=s.grades[4];
    total3+=s.grades[3];
    total2+=s.grades[2];
  });

  document.getElementById("total5").textContent=total5;
  document.getElementById("total4").textContent=total4;
  document.getElementById("total3").textContent=total3;
  document.getElementById("total2").textContent=total2;

  updateChart(total5,total4,total3,total2);
}

let chartInstance;

function updateChart(t5,t4,t3,t2){
  const ctx=document.getElementById("gradeChart");
  if(chartInstance) chartInstance.destroy();

  chartInstance=new Chart(ctx,{
    type:"doughnut",
    data:{
      labels:["5","4","3","2"],
      datasets:[{
        data:[t5,t4,t3,t2],
        backgroundColor:["#2ecc71","#3498db","#f1c40f","#e74c3c"]
      }]
    }
  });
}

function applyFilter(){
  updateTable(studentsData);
}

function exportExcel(){
  const ws_data=[
    ["Оқушы","5","4","3","2"],
    ...studentsData.map(s=>[s.name,s.grades[5],s.grades[4],s.grades[3],s.grades[2]])
  ];

  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Мониторинг");
  XLSX.writeFile(wb,"monitoring.xlsx");
}

updateTable(studentsData);
</script>

</body>
</html>